import numpy as np

# -----------------------------------------------------------------------------
#                   –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò –ú–û–î–ï–õ–ò
# -----------------------------------------------------------------------------

def calculate_vortex_vector(r, theta, p0, p1):
    """
    –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–æ—Ä–º—É–ª—ã "–í–∏—Ö—Ä—å –õ–µ–æ–Ω–æ–≤–∞": v(r, Œ∏) = polar_vec(p1¬∑tanh(r), p0+Œ∏)
    –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –ø–æ–ª—è—Ä–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–µ–∫–∞—Ä—Ç–æ–≤—ã –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –≤–µ–∫—Ç–æ—Ä–∞ (vx, vy).
    """
    magnitude = p1 * np.tanh(r)
    angle = p0 + theta
    vx = magnitude * np.cos(angle)
    vy = magnitude * np.sin(angle)
    return vx, vy

def calculate_vortex_from_xy(x, y, p0, p1, center_x=0, center_y=0):
    """
    –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –¥–µ–∫–∞—Ä—Ç–æ–≤—ã–º–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏.
    –í—ã—á–∏—Å–ª—è–µ—Ç –≤–µ–∫—Ç–æ—Ä —Å–∫–æ—Ä–æ—Å—Ç–∏ –≤ —Ç–æ—á–∫–µ (x, y) –¥–ª—è –≤–∏—Ö—Ä—è —Å —Ü–µ–Ω—Ç—Ä–æ–º –≤ (center_x, center_y).
    """
    # –°–º–µ—â–∞–µ–º —Å–∏—Å—Ç–µ–º—É –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –∫ —Ü–µ–Ω—Ç—Ä—É –≤–∏—Ö—Ä—è
    rel_x, rel_y = x - center_x, y - center_y
    
    # –ü–µ—Ä–µ–≤–æ–¥–∏–º –≤ –ø–æ–ª—è—Ä–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
    r = np.hypot(rel_x, rel_y)
    if r < 1e-9:  # –ò–∑–±–µ–≥–∞–µ–º –ø—Ä–æ–±–ª–µ–º –≤ —Å–∞–º–æ–º —Ü–µ–Ω—Ç—Ä–µ
        return 0.0, 0.0
    theta = np.arctan2(rel_y, rel_x)
    
    return calculate_vortex_vector(r, theta, p0, p1)

# -----------------------------------------------------------------------------
#        –§–£–ù–ö–¶–ò–ò –î–õ–Ø –í–´–ß–ò–°–õ–ï–ù–ò–Ø –î–ò–í–ï–†–ì–ï–ù–¶–ò–ò –ò –†–û–¢–û–†–ê (–í–ï–ö–¢–û–†–ù–´–ô –ê–ù–ê–õ–ò–ó)
# -----------------------------------------------------------------------------

def get_divergence(x, y, p0, p1, h=1e-6):
    """
    –ß–∏—Å–ª–µ–Ω–Ω–æ –≤—ã—á–∏—Å–ª—è–µ—Ç –¥–∏–≤–µ—Ä–≥–µ–Ω—Ü–∏—é (‚àá¬∑v) –ø–æ–ª—è –≤ —Ç–æ—á–∫–µ (x, y).
    –î–∏–≤–µ—Ä–≥–µ–Ω—Ü–∏—è –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ç–æ—á–∫–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–º –∏–ª–∏ —Å—Ç–æ–∫–æ–º.
    """
    # ‚àÇvx/‚àÇx ‚âà (vx(x+h) - vx(x-h)) / (2h)
    vx_plus_h, _ = calculate_vortex_from_xy(x + h, y, p0, p1)
    vx_minus_h, _ = calculate_vortex_from_xy(x - h, y, p0, p1)
    dvx_dx = (vx_plus_h - vx_minus_h) / (2 * h)
    
    # ‚àÇvy/‚àÇy ‚âà (vy(y+h) - vy(y-h)) / (2h)
    _, vy_plus_h = calculate_vortex_from_xy(x, y + h, p0, p1)
    _, vy_minus_h = calculate_vortex_from_xy(x, y - h, p0, p1)
    dvy_dy = (vy_plus_h - vy_minus_h) / (2 * h)
    
    return dvx_dx + dvy_dy

def get_curl_z(x, y, p0, p1, h=1e-6):
    """
    –ß–∏—Å–ª–µ–Ω–Ω–æ –≤—ã—á–∏—Å–ª—è–µ—Ç Z-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç—É —Ä–æ—Ç–æ—Ä–∞ (‚àá√óv) –ø–æ–ª—è –≤ —Ç–æ—á–∫–µ (x, y).
    –†–æ—Ç–æ—Ä –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç "–∑–∞–∫—Ä—É—á–µ–Ω–Ω–æ—Å—Ç—å" –ø–æ–ª—è.
    """
    # ‚àÇvy/‚àÇx ‚âà (vy(x+h) - vy(x-h)) / (2h)
    _, vy_plus_h = calculate_vortex_from_xy(x + h, y, p0, p1)
    _, vy_minus_h = calculate_vortex_from_xy(x - h, y, p0, p1)
    dvy_dx = (vy_plus_h - vy_minus_h) / (2 * h)
    
    # ‚àÇvx/‚àÇy ‚âà (vx(y+h) - vx(y-h)) / (2h)
    vx_plus_h, _ = calculate_vortex_from_xy(x, y + h, p0, p1)
    vx_minus_h, _ = calculate_vortex_from_xy(x, y - h, p0, p1)
    dvx_dy = (vx_plus_h - vx_minus_h) / (2 * h)
    
    return dvy_dx - dvx_dy

# -----------------------------------------------------------------------------
#                         –û–°–ù–û–í–ù–ê–Ø –¢–ï–°–¢–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø
# -----------------------------------------------------------------------------

def run_all_tests():
    """–ó–∞–ø—É—Å–∫–∞–µ—Ç –ø–æ–ª–Ω—É—é —Å–µ—Ä–∏—é —Ç–µ—Å—Ç–æ–≤ –¥–ª—è –≤—Å–µ—Å—Ç–æ—Ä–æ–Ω–Ω–µ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ "–í–∏—Ö—Ä—è –õ–µ–æ–Ω–æ–≤–∞"."""
    print("--- –ó–ê–ü–£–°–ö –ü–û–õ–ù–û–ì–û –ù–ê–ë–û–†–ê –¢–ï–°–¢–û–í –î–õ–Ø '–í–ò–•–†–Ø –õ–ï–û–ù–û–í–ê' ---\n")
    
    # --- –ë–ê–ó–û–í–´–ï –¢–ï–°–¢–´ ---
    print("--- –†–∞–∑–¥–µ–ª 1: –ë–∞–∑–æ–≤—ã–µ —Å–≤–æ–π—Å—Ç–≤–∞ –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã ---")
    
    # –¢–µ—Å—Ç 1: –ü–æ–≤–µ–¥–µ–Ω–∏–µ –≤ —Ü–µ–Ω—Ç—Ä–µ (r=0)
    vx, vy = calculate_vortex_vector(r=0, theta=0, p0=0.5, p1=1.2)
    assert np.isclose(vx, 0) and np.isclose(vy, 0), "–¢–µ—Å—Ç 1 –ü–†–û–í–ê–õ–ï–ù: –í–µ–∫—Ç–æ—Ä –≤ —Ü–µ–Ω—Ç—Ä–µ –Ω–µ –Ω—É–ª–µ–≤–æ–π!"
    print("‚úÖ –¢–µ—Å—Ç 1 –ü–†–û–ô–î–ï–ù: –í–µ–∫—Ç–æ—Ä –≤ —Ü–µ–Ω—Ç—Ä–µ (r=0) –Ω—É–ª–µ–≤–æ–π.")

    # –¢–µ—Å—Ç 2: –ü–æ–≤–µ–¥–µ–Ω–∏–µ –Ω–∞ –±–æ–ª—å—à–æ–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–∏ (r -> ‚àû)
    p1_test = 1.5
    vx, vy = calculate_vortex_vector(r=1000, theta=np.pi/4, p0=0.5, p1=p1_test)
    magnitude = np.hypot(vx, vy)
    assert np.isclose(magnitude, p1_test), f"–¢–µ—Å—Ç 2 –ü–†–û–í–ê–õ–ï–ù: –ú–æ–¥—É–ª—å {magnitude} –Ω–µ —Å—Ç—Ä–µ–º–∏—Ç—Å—è –∫ p1={p1_test}."
    print("‚úÖ –¢–µ—Å—Ç 2 –ü–†–û–ô–î–ï–ù: –ú–æ–¥—É–ª—å –Ω–∞ –±–æ–ª—å—à–æ–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–∏ –Ω–∞—Å—ã—â–∞–µ—Ç—Å—è –¥–æ p1.")

    # –¢–µ—Å—Ç 3: –≠—Ñ—Ñ–µ–∫—Ç p0 (–∏–¥–µ–∞–ª—å–Ω—ã–π –≤–∏—Ö—Ä—å)
    r_test, theta_test, p1_test = 2.0, np.pi/6, 1.0
    p0_vortex = np.pi / 2
    x, y = r_test * np.cos(theta_test), r_test * np.sin(theta_test)
    vx, vy = calculate_vortex_vector(r_test, theta_test, p0_vortex, p1_test)
    dot_product = x * vx + y * vy
    assert np.isclose(dot_product, 0), "–¢–µ—Å—Ç 3 –ü–†–û–í–ê–õ–ï–ù: –ü—Ä–∏ p0=œÄ/2 –≤–µ–∫—Ç–æ—Ä –Ω–µ –∫–∞—Å–∞—Ç–µ–ª—å–Ω—ã–π."
    print("‚úÖ –¢–µ—Å—Ç 3 –ü–†–û–ô–î–ï–ù: –ü—Ä–∏ p0=œÄ/2 —Å–æ–∑–¥–∞–µ—Ç—Å—è –∏–¥–µ–∞–ª—å–Ω—ã–π –∫—Ä—É–≥–æ–≤–æ–π –≤–∏—Ö—Ä—å.")
    
    # –¢–µ—Å—Ç 4: –≠—Ñ—Ñ–µ–∫—Ç p1 (–º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏–ª—ã)
    r_test, theta_test, p0_test = 1.0, np.pi, 0.5
    p1_base = 1.2
    vx1, vy1 = calculate_vortex_vector(r_test, theta_test, p0_test, p1_base)
    vx2, vy2 = calculate_vortex_vector(r_test, theta_test, p0_test, p1_base * 2)
    mag1, mag2 = np.hypot(vx1, vy1), np.hypot(vx2, vy2)
    assert np.isclose(mag2 / mag1, 2.0), "–¢–µ—Å—Ç 4 –ü–†–û–í–ê–õ–ï–ù: –£–¥–≤–æ–µ–Ω–∏–µ p1 –Ω–µ —É–¥–≤–∞–∏–≤–∞–µ—Ç –º–æ–¥—É–ª—å."
    print("‚úÖ –¢–µ—Å—Ç 4 –ü–†–û–ô–î–ï–ù: –ü–∞—Ä–∞–º–µ—Ç—Ä p1 –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ—Ç —Å–∏–ª—É –≤–µ–∫—Ç–æ—Ä–∞.")

    # --- –¢–ï–°–¢–´ –°–ò–ú–ú–ï–¢–†–ò–ò –ò –°–£–ü–ï–†–ü–û–ó–ò–¶–ò–ò ---
    print("\n--- –†–∞–∑–¥–µ–ª 2: –°–∏–º–º–µ—Ç—Ä–∏—è –∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ ---")

    # –¢–µ—Å—Ç 5: –ü–æ–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–∏ p0 = œÄ (–∏–¥–µ–∞–ª—å–Ω—ã–π —Å—Ç–æ–∫)
    r_test, theta_test, p1_test = 2.0, np.pi / 4, 1.0
    p0_sink = np.pi
    vx, vy = calculate_vortex_vector(r_test, theta_test, p0_sink, p1_test)
    angle_of_velocity = np.arctan2(vy, vx)
    expected_angle = (theta_test + np.pi) % (2 * np.pi)
    # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º —É–≥–ª—ã –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
    angle_of_velocity = (angle_of_velocity + 2 * np.pi) % (2 * np.pi)
    assert np.isclose(angle_of_velocity, expected_angle), "–¢–µ—Å—Ç 5 –ü–†–û–í–ê–õ–ï–ù: –ü—Ä–∏ p0=œÄ –≤–µ–∫—Ç–æ—Ä –Ω–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω –∫ —Ü–µ–Ω—Ç—Ä—É."
    print("‚úÖ –¢–µ—Å—Ç 5 –ü–†–û–ô–î–ï–ù: –ü—Ä–∏ p0=œÄ —Å–æ–∑–¥–∞–µ—Ç—Å—è –∏–¥–µ–∞–ª—å–Ω—ã–π —Å—Ç–æ–∫.")
    
    # –¢–µ—Å—Ç 6: –†–æ—Ç–∞—Ü–∏–æ–Ω–Ω–∞—è —Å–∏–º–º–µ—Ç—Ä–∏—è
    r_test, theta_test, p0_test, p1_test = 1.5, np.pi/3, 0.5, 1.2
    rotation_angle = np.pi / 6
    vx1, vy1 = calculate_vortex_vector(r_test, theta_test, p0_test, p1_test)
    vx2, vy2 = calculate_vortex_vector(r_test, theta_test + rotation_angle, p0_test, p1_test)
    vx1_rotated = vx1 * np.cos(rotation_angle) - vy1 * np.sin(rotation_angle)
    vy1_rotated = vx1 * np.sin(rotation_angle) + vy1 * np.cos(rotation_angle)
    assert np.isclose(vx1_rotated, vx2) and np.isclose(vy1_rotated, vy2), "–¢–µ—Å—Ç 6 –ü–†–û–í–ê–õ–ï–ù: –§–æ—Ä–º—É–ª–∞ –Ω–µ –æ–±–ª–∞–¥–∞–µ—Ç —Ä–æ—Ç–∞—Ü–∏–æ–Ω–Ω–æ–π —Å–∏–º–º–µ—Ç—Ä–∏–µ–π."
    print("‚úÖ –¢–µ—Å—Ç 6 –ü–†–û–ô–î–ï–ù: –§–æ—Ä–º—É–ª–∞ –æ–±–ª–∞–¥–∞–µ—Ç —Ä–æ—Ç–∞—Ü–∏–æ–Ω–Ω–æ–π —Å–∏–º–º–µ—Ç—Ä–∏–µ–π.")

    # –¢–µ—Å—Ç 7: –°—É–ø–µ—Ä–ø–æ–∑–∏—Ü–∏—è –¥–≤—É—Ö –≤–∏—Ö—Ä–µ–π
    p0, p1 = np.pi / 2, 1.0
    vx1, vy1 = calculate_vortex_from_xy(0, 0, p0, p1, center_x=-1)
    vx2, vy2 = calculate_vortex_from_xy(0, 0, p0, p1, center_x=1)
    vx_sum, vy_sum = vx1 + vx2, vy1 + vy2
    assert np.isclose(vy_sum, 0.0), "–¢–µ—Å—Ç 7 –ü–†–û–í–ê–õ–ï–ù: –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –Ω–µ —Å–∫–æ–º–ø–µ–Ω—Å–∏—Ä–æ–≤–∞–ª–∏—Å—å."
    assert np.isclose(vx_sum, 0.0), "–¢–µ—Å—Ç 7 –ü–†–û–í–ê–õ–ï–ù: –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –Ω–µ —Ä–∞–≤–Ω—ã –Ω—É–ª—é."
    print("‚úÖ –¢–µ—Å—Ç 7 –ü–†–û–ô–î–ï–ù: –°—É–ø–µ—Ä–ø–æ–∑–∏—Ü–∏—è –¥–≤—É—Ö –≤–∏—Ö—Ä–µ–π —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ.")

    # --- –§–£–ù–î–ê–ú–ï–ù–¢–ê–õ–¨–ù–´–ï –§–ò–ó–ò–ß–ï–°–ö–ò–ï –¢–ï–°–¢–´ ---
    print("\n--- –†–∞–∑–¥–µ–ª 3: –§—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ —Å–≤–æ–π—Å—Ç–≤–∞ (–í–µ–∫—Ç–æ—Ä–Ω—ã–π –∞–Ω–∞–ª–∏–∑) ---")

    # –¢–µ—Å—Ç 8: –ò–¥–µ–∞–ª—å–Ω—ã–π –≤–∏—Ö—Ä—å (p0=œÄ/2) –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ—Å–∂–∏–º–∞–µ–º—ã–º (div ‚âà 0)
    div = get_divergence(x=1.5, y=1.0, p0=np.pi / 2, p1=1.0)
    assert np.isclose(div, 0, atol=1e-5), f"–¢–µ—Å—Ç 8 –ü–†–û–í–ê–õ–ï–ù: –ò–¥–µ–∞–ª—å–Ω—ã–π –≤–∏—Ö—Ä—å —Å–∂–∏–º–∞–µ–º, div = {div}"
    print("‚úÖ –¢–µ—Å—Ç 8 –ü–†–û–ô–î–ï–ù: –ò–¥–µ–∞–ª—å–Ω—ã–π –≤–∏—Ö—Ä—å (p0=œÄ/2) –Ω–µ—Å–∂–∏–º–∞–µ–º (–ø–æ–ª–µ —Å–æ–ª–µ–Ω–æ–∏–¥–∞–ª—å–Ω–æ–µ).")
    
    # –¢–µ—Å—Ç 9: –ß–∏—Å—Ç—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ (p0=0) –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –±–µ–∑–≤–∏—Ö—Ä–µ–≤—ã–º (curl ‚âà 0)
    curl = get_curl_z(x=1.5, y=1.0, p0=0, p1=1.0)
    assert np.isclose(curl, 0, atol=1e-5), f"–¢–µ—Å—Ç 9 –ü–†–û–í–ê–õ–ï–ù: –ß–∏—Å—Ç—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏–º–µ–µ—Ç –∑–∞–∫—Ä—É—á–µ–Ω–Ω–æ—Å—Ç—å, curl = {curl}"
    print("‚úÖ –¢–µ—Å—Ç 9 –ü–†–û–ô–î–ï–ù: –ß–∏—Å—Ç—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ (p0=0) –±–µ–∑–≤–∏—Ö—Ä–µ–≤–æ–π (–ø–æ–ª–µ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–µ).")

    # –¢–µ—Å—Ç 10: –°–ø–∏—Ä–∞–ª—å–Ω—ã–π –≤–∏—Ö—Ä—å (p0=0.5) –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∏ —Å–∂–∏–º–∞–µ–º—ã–º, –∏ –≤–∏—Ö—Ä–µ–≤—ã–º
    div = get_divergence(x=1.5, y=1.0, p0=0.5, p1=1.0)
    curl = get_curl_z(x=1.5, y=1.0, p0=0.5, p1=1.0)
    assert not np.isclose(div, 0, atol=1e-5), f"–¢–µ—Å—Ç 10 –ü–†–û–í–ê–õ–ï–ù: –°–ø–∏—Ä–∞–ª—å–Ω—ã–π –≤–∏—Ö—Ä—å –Ω–µ—Å–∂–∏–º–∞–µ–º, div = {div}"
    assert not np.isclose(curl, 0, atol=1e-5), f"–¢–µ—Å—Ç 10 –ü–†–û–í–ê–õ–ï–ù: –°–ø–∏—Ä–∞–ª—å–Ω—ã–π –≤–∏—Ö—Ä—å –±–µ–∑–≤–∏—Ö—Ä–µ–≤–æ–π, curl = {curl}"
    print("‚úÖ –¢–µ—Å—Ç 10 –ü–†–û–ô–î–ï–ù: –°–ø–∏—Ä–∞–ª—å–Ω—ã–π –≤–∏—Ö—Ä—å —è–≤–ª—è–µ—Ç—Å—è –∏ —Å–∂–∏–º–∞–µ–º—ã–º, –∏ –≤–∏—Ö—Ä–µ–≤—ã–º.")
    
    print("\n\n--- üìú –í–ï–†–î–ò–ö–¢: –í–°–ï –¢–ï–°–¢–´ –£–°–ü–ï–®–ù–û –ü–†–û–ô–î–ï–ù–´! üìú ---\n")
    print("–ú–æ–¥–µ–ª—å '–í–∏—Ö—Ä—å –õ–µ–æ–Ω–æ–≤–∞' –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫—É—é —Å–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ —Ñ–∏–∑–∏—á–µ—Å–∫—É—é –∞–¥–µ–∫–≤–∞—Ç–Ω–æ—Å—Ç—å.")


# --- –û—Å–Ω–æ–≤–Ω–æ–π –±–ª–æ–∫ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–æ–≤ ---
if __name__ == "__main__":
    run_all_tests()
